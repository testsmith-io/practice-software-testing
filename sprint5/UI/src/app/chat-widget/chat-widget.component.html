<div class="chat-widget" *transloco="let t">
  <!-- Chat Toggle Button -->
  @if (!isOpen) {
    <button class="chat-toggle-btn"
            (click)="toggleChat()"
            aria-label="Open chat"
            data-test="chat-toggle">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
      </svg>
    </button>
  }

  <!-- Chat Window -->
  @if (isOpen) {
    <div class="chat-window" data-test="chat-window">
      <!-- Header -->
      <div class="chat-header">
        <span class="chat-title">{{ t('chat.title') }}</span>
        <button class="chat-close-btn"
                (click)="closeChat()"
                aria-label="Close chat"
                data-test="chat-close">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <!-- Messages -->
      <div class="chat-messages" #messagesContainer>
        @for (message of messages; track message.id) {
          <div class="chat-message" [class.user-message]="message.type === 'user'" [class.bot-message]="message.type === 'bot'">
            <div class="message-content">
              {{ message.content.startsWith('chat.') ? t(message.content) : message.content }}
            </div>

            <!-- Product Results -->
            @if (message.products && message.products.length > 0) {
              <div class="product-list">
                @for (product of message.products; track product.id) {
                  <div class="product-card"
                       (click)="onProductClick(product)"
                       data-test="chat-product">
                    @if (product.image) {
                      <img [src]="product.image" [alt]="product.name" class="product-image">
                    }
                    <div class="product-info">
                      <div class="product-name">{{ product.name }}</div>
                      <div class="product-price">${{ product.price }}</div>
                    </div>
                  </div>
                }
              </div>
            }

            <!-- Action Buttons -->
            @if (message.actions && message.actions.length > 0) {
              <div class="action-buttons">
                @for (action of message.actions; track action.action) {
                  <button class="action-btn"
                          (click)="onActionClick(action)"
                          [attr.data-test]="'chat-action-' + action.action">
                    {{ action.label.startsWith('chat.') ? t(action.label) : action.label }}
                  </button>
                }
              </div>
            }
          </div>
        }

        @if (isLoading) {
          <div class="chat-message bot-message">
            <div class="message-content loading">
              <span class="dot"></span>
              <span class="dot"></span>
              <span class="dot"></span>
            </div>
          </div>
        }
      </div>

      <!-- Hidden file input for attachments -->
      <input type="file"
             #fileInput
             class="hidden-file-input"
             accept=".txt"
             (change)="onFileSelected($event)"
             data-test="chat-file-input">

      <!-- Input -->
      @if (showInput()) {
        <form class="chat-input-container" (ngSubmit)="onSubmit()">
          <input type="text"
                 class="chat-input"
                 [(ngModel)]="userInput"
                 name="userInput"
                 [placeholder]="t('chat.placeholder')"
                 autocomplete="off"
                 data-test="chat-input">
          <button type="submit"
                  class="chat-send-btn"
                  [disabled]="!userInput.trim()"
                  aria-label="Send message"
                  data-test="chat-send">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
          </button>
        </form>
      }
    </div>
  }
</div>
