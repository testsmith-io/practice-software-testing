<div class="jumbotron my-4">
  <p class="lead">
    <img fetchpriority="high" class="img-fluid" alt="Banner" src="../assets/img/barn-2400x1600.avif"/>
  </p>
  <hr class="my-4">
</div>
<div class="row">

</div>
<div class="row" *transloco="let t">
  <a class="btn btn-secondary d-block d-md-none btn-block mb-3" data-bs-toggle="collapse" data-test="filters"
     href="#filters"
     role="button" aria-expanded="false" aria-controls="collapseExample">
    <fa-icon [icon]="['fas', 'filter']"></fa-icon>
    {{ t('pages.overview.filters') }}
  </a>
  <div data-test="filters" id="filters" class="collapse d-md-block col-md-3 mb-3">
    <h4 class="grid-title">
      <fa-icon [icon]="['fas', 'arrows-up-down']"></fa-icon>
      {{ t('pages.overview.sort') }}
    </h4>
    <hr>
    <form autocomplete=off>
      <div class="input-group mb-3">
        <select aria-label="sort" data-test="sort" (change)="changeSorting($event)" class="form-select">
          <option value=""></option>
          <option value="name,asc">{{ t('pages.overview.sort-options.name-asc') }}</option>
          <option value="name,desc">{{ t('pages.overview.sort-options.name-desc') }}</option>
          <option value="price,desc">{{ t('pages.overview.sort-options.price-desc') }}</option>
          <option value="price,asc">{{ t('pages.overview.sort-options.price-asc') }}</option>
          @if (isCo2ScaleEnabled()) {
            <option value="co2_rating,asc">{{ t('pages.overview.sort-options.co2-asc') }}</option>
            <option value="co2_rating,desc">{{ t('pages.overview.sort-options.co2-desc') }}</option>
          }
        </select>
      </div>
    </form>

    <h4 class="grid-title">
      <fa-icon [icon]="['fas', 'arrows-left-right']"></fa-icon>
      {{ t('pages.overview.price-range') }}
    </h4>
    <hr>
    <div class="input-group mb-3">
      <ngx-slider (userChangeEnd)="changePriceRange()" [(value)]="minPrice" [(highValue)]="maxPrice"
                  [options]="sliderOptions"></ngx-slider>
    </div>

    <h4 class="grid-title">
      <fa-icon [icon]="['fas', 'search']"></fa-icon>
      {{ t('pages.overview.search') }}
    </h4>
    <hr>
    <form [formGroup]="search" (ngSubmit)="onSearchSubmit()" autocomplete=off>
      <div class="input-group mb-3">
        <label for="search-query" class="visually-hidden">{{ t('pages.overview.search') }}</label>
        <input formControlName="query" id="search-query" data-test="search-query" type="text"
               placeholder="{{ t('pages.overview.search') }}" class="form-control">
        <button (click)="reset()" class="btn btn-warning" type="reset"
                data-test="search-reset">X
        </button>
        <button class="btn btn-secondary" type="submit" data-test="search-submit">{{ t('pages.overview.search') }}
        </button>
      </div>
    </form>

    <h4 class="grid-title">
      <fa-icon [icon]="['fas', 'filter']"></fa-icon>
      {{ t('pages.overview.filters') }}
    </h4>
    <hr>
    <h4>{{ t('pages.overview.by-category') }}:</h4>
    <ng-template #recursiveList let-list let-parentId="parentId">
      <fieldset>
        <legend class="visually-hidden">{{ t('pages.overview.categories') }}</legend>
        @for (category of list; track category) {
          <div class="checkbox">
            <label>
              <!-- Category checkbox -->
              @if (!category.parent_id) {
                <!-- Top-level parent -->
                <input type="checkbox" class="icheck"
                       attr.data-test="category-{{category.id}}" name="category_id"
                       value="{{category.id}}"
                       [checked]="isCategorySelected(category)"
                       (change)="selectParentWithSubcategories(category, $event)"/>
              } @else {
                <!-- Child category -->
                <input type="checkbox" class="icheck"
                       attr.data-test="category-{{category.id}}" name="category_id"
                       value="{{category.id}}"
                       [checked]="isCategorySelected(category)"
                       (change)="filterByCategory($event, category.id, parentId)"/>
              }
              {{ category.name }}
            </label>
            <!-- Subcategories -->
            @if (category.sub_categories.length > 0) {
              <ul>
                <ng-container
                  *ngTemplateOutlet="recursiveList; context:{ $implicit: category.sub_categories, parentId: category.id }"></ng-container>
              </ul>
            }
          </div>
        }
      </fieldset>
    </ng-template>
    <ng-container *ngTemplateOutlet="recursiveList; context:{ $implicit: categories }"></ng-container>

    <div class="py-2"></div>

    <h4>{{ t('pages.overview.by-brand') }}:</h4>
    <fieldset>
      <legend class="visually-hidden">{{ t('pages.overview.brands') }}</legend>
      @for (brand of brands; track brand.id) {
        <div class="checkbox">
          <label><input #checkboxes type="checkbox" class="icheck" name="brand_id" attr.data-test="brand-{{brand.id}}"
                        value="{{brand.id}}"
                        (change)="filterByBrand($event)"/>
            {{ brand.name }}</label>
        </div>
      }
    </fieldset>

    <div class="py-2"></div>

    @if (isCo2ScaleEnabled()) {
      <h4>{{ t('pages.overview.sustainability') || 'Sustainability' }}:</h4>
      <fieldset>
        <legend class="visually-hidden">{{ t('pages.overview.eco-friendly') || 'Eco-Friendly Products' }}</legend>
        <div class="checkbox">
          <label><input #checkboxes type="checkbox" class="icheck" name="eco_friendly" data-test="eco-friendly-filter"
                        (change)="filterByEcoFriendly($event)"/>
            {{ t('pages.overview.show-eco-friendly') || 'Show only eco-friendly products' }}</label>
        </div>
      </fieldset>
    }

  </div>
  <div class="col-md-9" *transloco="let t">
    @if (searchQuery) {
      <h3 data-test="search-caption">Searched for: <span data-test="search-term">{{ searchQuery }}</span></h3>
    }
    @if (results) {
      <div class="container" attr.data-test="{{resultState}}">
        @if (!results.data.length) {
          <div data-test="no-results">{{ t('pages.overview.no-results') }}</div>
        }
        @for (item of results.data; track item.id) {
          <a attr.data-test="product-{{item.id}}" routerLink="/product/{{item.id}}"
             class="card" style="text-decoration: none; color: black;">
            <div class="card-img-wrapper">
              <img class="card-img-top" alt="{{ item.name }}"
                   loading="lazy"
                   src="assets/img/products/{{item.product_image.file_name}}">
              @if (item.is_eco_friendly && isEcoBadgeEnabled()) {
                <span class="eco-badge position-absolute top-0 end-0 m-2" data-test="eco-badge">
                  <fa-icon [icon]="['fas', 'leaf']"></fa-icon> ECO
                </span>
              }
            </div>
            <div class="card-body">
              <h5 data-test="product-name" class="card-title">
                {{ item.name }}
              </h5>
              @if (item.co2_rating && isCo2ScaleEnabled()) {
                <div class="co2-rating-scale"
                     [title]="t('pages.overview.co2-tooltip')"
                     data-test="co2-rating-badge">
                  <span class="co2-letter" [class.active]="item.co2_rating === 'A'" [class.rating-a]="item.co2_rating === 'A'">A</span>
                  <span class="co2-letter" [class.active]="item.co2_rating === 'B'" [class.rating-b]="item.co2_rating === 'B'">B</span>
                  <span class="co2-letter" [class.active]="item.co2_rating === 'C'" [class.rating-c]="item.co2_rating === 'C'">C</span>
                  <span class="co2-letter" [class.active]="item.co2_rating === 'D'" [class.rating-d]="item.co2_rating === 'D'">D</span>
                  <span class="co2-letter" [class.active]="item.co2_rating === 'E'" [class.rating-e]="item.co2_rating === 'E'">E</span>
                </div>
              }
            </div>
            <div class="card-footer">
              @if (!item.in_stock) {
                <span class="float-start text-danger" data-test="out-of-stock">{{ t('pages.overview.no-stock') }}</span>
              }
              <span class="float-end text-muted">
                   <span data-test="product-price"
                         [ngClass]="{'discounted' : item.discount_price}">${{ item.price.toFixed(2) }}</span> @if (item.discount_price) {
                <span
                  data-test="product-discount-price"> ${{ item.discount_price.toFixed(2) }}</span>
              }
        </span>
            </div>

          </a>
        }
      </div>
    } @else {
      <div class="container">
        @for (loader of itemsToLoad; track loader.id) {
          <div class="card skeleton">
            <div class="card-img-wrapper">
            </div>
            <div class="card-body">
              <h5 class="card-title">
              </h5>
            </div>
            <div class="card-footer">
      <span class="float-end text-muted">
      </span>
            </div>
          </div>
        }
      </div>
    }
    <div class="mt-3">
      <app-pagination [currentPage]="currentPage" [lastPage]="results?.last_page"
                      (pageChange)="onPageChange($event)"></app-pagination>
    </div>
  </div>
</div>
